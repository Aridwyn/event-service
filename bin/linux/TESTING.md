# Инструкция по тестированию

## Интеграционные тесты

### Быстрый старт

Самый простой способ протестировать сервис:

```bash
cd bin/linux
./test-runner
```

Эта команда:
- Автоматически запустит встроенный MongoDB
- Запустит тестовый HTTP-сервер
- Выполнит все 10 интеграционных тестов
- Покажет детальные результаты

### Сохранение результатов

Чтобы сохранить результаты тестов в файл:

```bash
./test-runner test-results.txt
```

### Что проверяют интеграционные тесты

1. **GET empty array** - Проверка пустой базы при старте
2. **POST start meeting** - Создание события типа "meeting"
3. **GET verify meeting** - Проверка сохранения события
4. **POST duplicate meeting** - Проверка отсутствия дубликатов (должен вернуть 200, не создавать новый)
5. **GET verify no duplicate** - Подтверждение отсутствия дубликата
6. **POST finish meeting** - Завершение события
7. **POST finish non-existent** - Обработка ошибки 404 для несуществующего события
8. **POST start call** - Создание события типа "call"
9. **POST start task** - Создание события типа "task"
10. **GET verify both events** - Проверка сортировки по времени и независимости типов

### Пример успешного выполнения

```
Запуск интеграционных тестов для event-service
================================================================================

Настройка тестового окружения...
Тестовый сервер запущен

[Test 1] GET empty array
------------------------------------------------------------
PASS
Время выполнения: 45.2ms

[Test 2] POST start meeting
------------------------------------------------------------
  Событие создано: id=507f1f77bcf86cd799439011, type=meeting, state=started
PASS
Время выполнения: 32.1ms

...

================================================================================
ИТОГОВЫЙ ОТЧЁТ
================================================================================
Всего тестов: 10
Пройдено:     10
Провалено:   0
Время выполнения: 2.3s
================================================================================

ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!
```

## Юнит-тесты (опционально)

Если у вас есть исходный код проекта на Linux, можно запустить юнит-тесты:

```bash
# Из корня проекта
go test ./...

# Только тесты сервиса
go test ./pkg/event/...

# С покрытием кода
go test -cover ./...

# С детальным выводом
go test -v ./...
```

## Ручное тестирование (через curl)

Если нужно протестировать вручную:

### 1. Запустите сервис

```bash
./event-service
```

Сервис запустится на порту 8080.

### 2. Протестируйте эндпоинты

```bash
# Получить список всех событий
curl http://localhost:8080/v1

# Создать событие типа "meeting"
curl -X POST http://localhost:8080/v1/start \
  -H "Content-Type: application/json" \
  -d '{"type": "meeting"}'

# Получить список снова (должно появиться событие)
curl http://localhost:8080/v1

# Завершить событие
curl -X POST http://localhost:8080/v1/finish \
  -H "Content-Type: application/json" \
  -d '{"type": "meeting"}'

# Получить список (событие должно быть завершено)
curl http://localhost:8080/v1
```

## Важные замечания

- **Порт 8080 должен быть свободен** при запуске тестов
- Тесты используют отдельную тестовую базу данных (`events_test_db`)
- Встроенный MongoDB запускается автоматически для тестов
- Для работы бинарников нужны права на выполнение: `chmod +x test-runner event-service`

## Использование в CI/CD

Тесты возвращают правильные exit codes:

```bash
# Bash скрипт для CI/CD
if ./test-runner; then
    echo "Все тесты пройдены"
    exit 0
else
    echo "Есть проваленные тесты"
    exit 1
fi
```

## Устранение проблем

### Ошибка: "port 8080 already in use"

```bash
# Найти процесс на порту 8080
lsof -i :8080
# или
netstat -tulpn | grep 8080

# Остановить процесс
kill <PID>
```

### Ошибка: "permission denied"

```bash
# Дать права на выполнение
chmod +x test-runner event-service
```

### Ошибка: "cannot execute binary file"

Убедитесь, что бинарники собраны для правильной архитектуры:
- Linux: x86_64/amd64
- Для других архитектур нужно пересобрать

## Примечания

- Интеграционные тесты проверяют полный цикл работы с API
- Тесты проверяют соответствие OpenAPI спецификации
- Все тесты автоматически очищают базу данных после завершения

