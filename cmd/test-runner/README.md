# Интеграционные тесты для event-service

Этот набор тестов проверяет соответствие сервиса требованиям из технического задания и OpenAPI спецификации.

## Описание тестов

Набор включает **10 интеграционных тестов**, которые проверяют:

> **Важно**: Тесты проверяют соответствие API OpenAPI спецификации (`task_openapi.yaml`). Ответы API должны соответствовать формату EventResponse с полями в camelCase (`startedAt`, `finishedAt`) и строковым значением `state` ("started" или "finished").

1. **GET empty array** — Проверка, что при старте база пуста
2. **POST start meeting** — Создание первого события типа "meeting" (возвращается 200 без тела ответа)
3. **GET verify meeting** — Проверка, что событие сохранилось в БД и имеет правильный формат (state="started", camelCase поля)
4. **POST duplicate meeting** — Проверка, что дубликат не создаётся (возвращается 200, не ошибка)
5. **GET verify no duplicate** — Подтверждение отсутствия дубликата
6. **POST finish meeting** — Завершение события (возвращается 200 без тела ответа)
7. **POST finish non-existent** — Попытка завершить несуществующее событие (ожидается 404 с Error в формате JSON)
8. **POST start call** — Создание события типа "call"
9. **POST start task** — Создание события типа "task"
10. **GET verify both events** — Проверка независимости типов и сортировки по `startedAt` в порядке убывания (descending)

## Требования

- Go 1.23 или выше
- Встроенный MongoDB (будет запущен автоматически)

## Запуск тестов

### Базовый запуск (результаты только в консоль)

```bash
go run ./cmd/test-runner
```

### Запуск с сохранением результатов в файл

```bash
go run ./cmd/test-runner test-results.txt
```

Результаты будут выведены в консоль и сохранены в указанный файл.

### Сборка и запуск исполняемого файла

```bash
# Сборка
go build -o test-runner.exe ./cmd/test-runner

# Windows
./test-runner.exe test-results.txt

# Linux/macOS
go build -o test-runner ./cmd/test-runner
./test-runner test-results.txt
```

## Что делает тестовый раннер

1. **Автоматически запускает встроенный MongoDB** для тестов
2. **Запускает тестовый HTTP-сервер** на порту 8080
3. **Выполняет все 10 тест-кейсов** последовательно
4. **Выводит результаты в консоль** и (опционально) в файл
5. **Автоматически очищает** тестовую базу данных после завершения

## Пример вывода

```
Запуск интеграционных тестов для event-service
================================================================================

Настройка тестового окружения...
Тестовый сервер запущен

[Test 1] GET empty array
------------------------------------------------------------
PASS
Время выполнения: 45.2ms

[Test 2] POST start meeting
------------------------------------------------------------
  Событие 'meeting' создано (или уже существует)
PASS
Время выполнения: 32.1ms

...

================================================================================
ИТОГОВЫЙ ОТЧЁТ
================================================================================
Всего тестов: 10
Пройдено:     10
Провалено:   0
Время выполнения: 2.3s
================================================================================

ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!
```

## Выходные коды

- `0` — все тесты пройдены успешно
- `1` — есть проваленные тесты

Это позволяет использовать тесты в CI/CD пайплайнах:

```bash
go run ./cmd/test-runner && echo "Tests passed" || echo "Tests failed"
```

## Примечания

- Тесты используют отдельную тестовую базу данных (`events_test_db`), которая автоматически очищается
- Порт 8080 должен быть свободен во время запуска тестов
- Тесты проверяют как корректные сценарии, так и обработку ошибок (404 для несуществующих событий)
- Тесты проверяют соответствие OpenAPI спецификации:
  - Формат ответов: `EventResponse` с полями `type`, `state` ("started"/"finished"), `startedAt`, `finishedAt`
  - POST `/v1/start` и POST `/v1/finish` возвращают 200 без тела ответа
  - Ошибки возвращаются в формате `Error` с полем `message`
  - GET `/v1` возвращает события, отсортированные по `startedAt` в порядке убывания

